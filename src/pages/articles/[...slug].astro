---
import { getCollection, type CollectionEntry } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import SocialShare from '../../components/SocialShare.astro';
import RelatedArticles from '../../components/RelatedArticles.astro';

export async function getStaticPaths() {
  const articles = await getCollection('articles');
  return articles.map((article) => ({
    params: { slug: article.slug },
    props: article,
  }));
}

type Props = CollectionEntry<'articles'>;

const article = Astro.props;
const { Content } = await article.render();

const formattedDate = article.data.pubDate.toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
}).toUpperCase();

import JsonLd from '../../components/JsonLd.astro';

const articleUrl = new URL(`/articles/${article.slug}`, Astro.site || 'https://anilkaraca.com').toString();
const imageUrl = article.data.heroImage ? new URL(article.data.heroImage, Astro.site || 'https://anilkaraca.com').toString() : undefined;

const blogPostingSchema = {
  "@type": "BlogPosting",
  "headline": article.data.title,
  "description": article.data.description,
  "datePublished": article.data.pubDate.toISOString(),
  "author": {
    "@type": "Person",
    "name": "Anıl Karaca"
  },
  "image": imageUrl,
  "url": articleUrl
};
---

<BaseLayout 
  title={article.data.title} 
  description={article.data.description}
  image={article.data.heroImage}
  article={true}
>
  <JsonLd schema={blogPostingSchema} />
  <Header />
  
  <article>
    <!-- Hero Section -->
    <div class="relative min-h-[70vh] flex items-center justify-center overflow-hidden">
      <!-- Background Image -->
      {article.data.heroImage && (
        <div class="absolute inset-0">
          <img 
            src={article.data.heroImage} 
            alt=""
            class="w-full h-full object-cover"
          />
          <!-- Gradient Overlay -->
          <div class="absolute inset-0 bg-gradient-to-b from-background/60 via-background/80 to-background"></div>
        </div>
      )}
      
      <!-- Content -->
      <div class="relative z-10 max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 text-center py-24">
        <!-- Category Badge -->
        <span class="inline-block text-sm font-medium px-4 py-1.5 bg-gold/90 text-background rounded-full capitalize mb-6">
          {article.data.category.replace('-', ' ')}
        </span>
        
        <!-- Title -->
        <h1 class="text-3xl sm:text-4xl md:text-5xl lg:text-6xl font-display font-bold text-white leading-tight mb-8">
          {article.data.title}
        </h1>
        
        <!-- Author & Meta -->
        <div class="flex items-center justify-center gap-4">
          <!-- Author Avatar -->
          <div class="w-12 h-12 rounded-full bg-gradient-to-br from-primary to-secondary flex items-center justify-center text-white font-bold text-lg">
            AK
          </div>
          <div class="text-left">
            <div class="text-white font-medium">Anıl Karaca</div>
            <div class="text-muted-foreground text-sm">{formattedDate}</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Social Share Bar -->
    <div class="bg-card border-y border-primary/10">
      <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
        <SocialShare title={article.data.title} url={articleUrl} />
      </div>
    </div>

    <!-- Main Content -->
    <div class="py-16">
      <div class="article-content px-4 sm:px-6 lg:px-8">
        <!-- Description/Lead -->
        {article.data.description && (
          <p class="article-lead">
            {article.data.description}
          </p>
        )}
        
        <!-- Article Content with Premium Typography -->
        <div class="prose-article">
          <Content />
        </div>

        <!-- Tags -->
        {article.data.tags.length > 0 && (
          <div class="mt-16 pt-8 border-t border-primary/10">
            <div class="flex flex-wrap gap-2">
              {article.data.tags.map((tag) => (
                <span class="article-tag">
                  #{tag}
                </span>
              ))}
            </div>
          </div>
        )}

        <!-- Related Articles -->
        <RelatedArticles 
          currentSlug={article.slug} 
          category={article.data.category} 
        />

        <!-- Back Link -->
        <div class="mt-16 pt-8 border-t border-primary/10">
          <a 
            href="/articles"
            class="inline-flex items-center gap-2 text-gold hover:text-gold-light transition-colors group"
          >
            <svg class="w-4 h-4 transition-transform group-hover:-translate-x-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
            </svg>
            Back to All Articles
          </a>
        </div>
      </div>
    </div>
  </article>

  <!-- Reading Progress Bar -->
  <div id="reading-progress" class="reading-progress" style="transform: scaleX(0);"></div>
  
  <script>
    const progressBar = document.getElementById('reading-progress');
    const article = document.querySelector('article');
    
    if (progressBar && article) {
      window.addEventListener('scroll', () => {
        const articleRect = article.getBoundingClientRect();
        const articleTop = articleRect.top + window.scrollY;
        const articleHeight = articleRect.height;
        const windowHeight = window.innerHeight;
        
        const scrolled = window.scrollY - articleTop + windowHeight;
        const progress = Math.min(Math.max(scrolled / articleHeight, 0), 1);
        
        progressBar.style.transform = `scaleX(${progress})`;
      });
    }
  </script>

  <Footer />
</BaseLayout>
